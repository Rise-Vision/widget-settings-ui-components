var RiseVision=RiseVision||{};RiseVision.Common=RiseVision.Common||{},RiseVision.Common.LoggerUtils=function(){"use strict";function e(e,t){var o=null;e.event?(o=e,o.file_url&&(o.file_format=n(o.file_url)),o.company_id=g,o.display_id=l,u&&(o.version=u),t(o)):t(o)}function t(){var e=new Date,t=e.getUTCFullYear(),n=e.getUTCMonth()+1,o=e.getUTCDate();return 10>n&&(n="0"+n),10>o&&(o="0"+o),""+t+n+o}function n(e){var t,n=/[?#&]/;return e&&"string"==typeof e?(t=e.substr(e.lastIndexOf(".")+1),n.test(t)&&(t=t.substr(0,-1!==t.indexOf("?")?t.indexOf("?"):t.length),t=t.substr(0,-1!==t.indexOf("#")?t.indexOf("#"):t.length),t=t.substr(0,-1!==t.indexOf("&")?t.indexOf("&"):t.length)),t.toLowerCase()):null}function o(e){var n={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:t(),rows:[{insertId:""}]},o=JSON.parse(JSON.stringify(n));return o.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),o.rows[0].json=JSON.parse(JSON.stringify(e)),o.rows[0].json.ts=(new Date).toISOString(),o}function s(t,n){e(n,function(e){null!==e&&RiseVision.Common.Logger.log(t,e)})}function i(e,n){try{top.postToPlayer({message:"widget-log",table:e,params:JSON.stringify(n),suffix:t()})}catch(o){console.log("widget-common.logEventToPlayer",o)}}function r(e,t){g=e,l=t}function a(e){u=e}var l="",g="",u=null;return{getInsertData:o,getFileFormat:n,logEvent:s,logEventToPlayer:i,setIds:r,setVersion:a}}(),RiseVision.Common.Logger=function(e){"use strict";function t(e){var t=new XMLHttpRequest;return new Date-g<358e4?e({}):(t.open("POST",s,!0),t.onloadend=function(){var n={};try{n=JSON.parse(t.response)}catch(o){console.warn("Can't refresh logger token - ",o.message)}e({token:n.access_token,refreshedAt:new Date})},t.send(),void 0)}function n(e){return r&&l===e}function o(o,s){function c(t){var n,r,a=new XMLHttpRequest;r=i.replace("TABLE_ID",o),g=t.refreshedAt||g,u=t.token||u,n=e.getInsertData(s),a.open("POST",r,!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("Authorization","Bearer "+u),s.cb&&"function"==typeof s.cb&&(a.onloadend=function(){s.cb(a.response)}),a.send(JSON.stringify(n))}if(!(!o||!s||s.hasOwnProperty("event")&&!s.event||s.hasOwnProperty("event")&&n(s.event))&&s.display_id&&"preview"!==s.display_id&&"display_id"!==s.display_id&&"displayId"!==s.display_id){try{if(top.postToPlayer&&top.enableWidgetLogging)return e.logEventToPlayer(o,s)}catch(d){console.log("widget-common: logger",d)}return r=!0,l=s.event,setTimeout(function(){r=!1},a),t(c)}}var s="https://www.googleapis.com/oauth2/v3/token?client_id="+WIDGET_COMMON_CONFIG.LOGGER_CLIENT_ID+"&client_secret="+WIDGET_COMMON_CONFIG.LOGGER_CLIENT_SECRET+"&refresh_token="+WIDGET_COMMON_CONFIG.LOGGER_REFRESH_TOKEN+"&grant_type=refresh_token",i="https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Widget_Events/tables/TABLE_ID/insertAll",r=!1,a=1e3,l="",g=0,u="";return{log:o}}(RiseVision.Common.LoggerUtils);